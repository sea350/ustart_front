<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>ustart</title>
	<link rel="stylesheet" href="/ustart_front/css/inbox.css">
	<script src="/ustart_front/js/chat.js"></script>
    <script>
        var sockets = [];
        var chatflag = 1;
        var roomflag = 1;
        var timerID=0;
        var port = window.location.port;
    </script>
</head>
<body>
   <div id="centering" style="top: 0; padding-top: 5em; padding-bottom: 1em; width:80%; margin: 0 auto;">
       <div id="content">
			<div id="container-full">
				<div class="container-left">
					<h3 class="container-left-header">
						Messages
					</h3>
					<!--<div class="input-group inbox-search-box">
                        <input type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default" placeholder="Search">
                        <span class="input-group-addon">
                            <button class="btn btn-default" type="button"><i class="glyphicon glyphicon-search"></i></button>
                       </span>
					</div>
					<br/>-->
					<ul id="inbox-groups">
                        <!-- sample chat replace variables -->
						<li class="inbox-group" id="@jyang">
                            <div class="inbox-image"><img class="inbox-icon" src=""/></div>
							<div class="inbox-side-content">
                                <div class = "inbox-left-bar">
                                    <div class = "inbox-header">
                                    <span class="group-header" >Pikachu Chat</span>
                                    </div>
                                    <div class = "inbox-timestamp">
                                    <span class="group-message-time">5:00 PM</span>
                                    </div>
                                </div>
                                <div class = "inbox-last-msg">
                                <span class="group-message"></span>
                                </div>
                            </div>
						</li>
					</ul>
				</div>
				<div class="container-right">
					<div class="box-chat">
						<h3 class="message-head">Chat
                        <!-- collapsable member list -->
                        <a id="sidebarCollapse" data-toggle="tooltip" data-placement="top" title="Members" style="float:right;">
				            <i class="fa fa-angle-double-left" style="color:#00ac7d;"></i>
						</a>
                        </h3>
						<div class="box-section">
							<div class="section-left">
								<ul class="message-box">
									<script>
                                        $( document ).ready(function() {
                                             var socket2 = new WebSocket('ws://' + window.location.host + '/cN/');
                                             function GetChatRecord(){
                                                console.log("scrolling");
                                                // Do something.
                                                // Load data or whatever.
                                              /*   if (chatflag == 1){
                                                    chatflag=0;
                                                     $.ajax({
                                                        type: 'GET',
                                                        url: 'http://ustart.today:'+port+'//',
                                                        contentType: "application/json; charset=utf-8",
                                                        data: {postIndex:JSON.stringify(chatArr)},
                                                        success: function(data) {   
                                                        },complete: function (jqXHR,status) {
                                                             chatflag=1;
                                                             if(status == 'success' || status=='notmodified')
                                                             {

                                                             }
                                                        },error: function(err) {
                                                            console.log('chat Load failed: ');
                                                            console.log(err);
                                                        }
                                                    });
                                                }*/
                                            }
                                            function GetChatrooms(){
                                                if (roomflag == 1){
                                                    roomflag=0;
                                                    console.log("hello");
                                                   /*  $.ajax({
                                                        type: 'GET',
                                                        url: 'http://ustart.today:'+port+'//',
                                                        contentType: "application/json; charset=utf-8",
                                                        data: {postIndex:JSON.stringify(roomArr)},
                                                        success: function(data) {   
                                                        },complete: function (jqXHR,status) {
                                                             roomflag=1;
                                                             if(status == 'success' || status=='notmodified')
                                                             {

                                                             }
                                                        },error: function(err) {
                                                            console.log('chatroom Load failed: ');
                                                            console.log(err);
                                                        }
                                                    });*/
                                                }
                                            }

                                            $(".message-box").scroll(function () {
                                                var $this = $(this);
                                                var height = this.scrollHeight - $this.height(); // Get the height of the div
                                                var scroll = $this.scrollTop(); // Get the vertical scroll position
                                                var isScrolledToEnd = (scroll <= 0);
                                                if (isScrolledToEnd) {
                                                    GetChatRecord(); // Get the additional content
                                                }
                                            });
                                            
                                              $(".container-left").scroll(function () {
                                                var $this = $(this);
                                                var roomHeight = this.scrollHeight - $this.height(); // Get the height of the div
                                                var roomScroll = $this.scrollTop(); // Get the vertical scroll position
                                                var isScrolledToEnd = (roomScroll > roomHeight);
                                                if (isScrolledToEnd) {
                                                    GetChatrooms(); // Get the additional content
                                                }
                                            });
                                            
                                            function start(){
                                                //initial set up
                                                if(!("WebSocket" in window)){
                                                    console.log("you need a browser that supports web sockets");
                                                 }else{
                                                     try{
                                                        if (sockets.length>0){
                                                            sockets.forEach(function(s) {
                                                                s.close();
                                                                sockets=[];
                                                            });
                                                        }
                                                        var temp = window.location.href.indexOf("ch");
                                                        var urlid = window.location.href.substring(temp+3);
                                                        if (urlid===""){
                                                            window.history.pushState("", "", "/ch/");
                                                            $(".message-box").attr("id", "chat");
                                                            $(".inputMessages").attr("id", "messager");
                                                            $('.chat-submit').attr("id", "chat-submit");
                                                        }
                                                        else{
                                                            window.history.pushState("", "", "/ch/"+urlid);
                                                            $('[id="'+urlid+'"]').addClass('active');
                                                            $(".message-box").attr("id", "chat"+ urlid);
                                                            $(".inputMessages").attr("id", "messager"+ urlid);
                                                            $('.chat-submit').attr("id", "chat-submit"+ urlid);
                                                        }
                                                        socket = new WebSocket('ws://' + window.location.host + '/ws/'+urlid);
                                                        socket.onopen = function(){
                                                            console.log('Socket Status: '+socket.readyState+'(open)');
                                                            sockets.push(socket);
                                                            if(window.timerID){ /* a setInterval has been fired */
                                                               window.clearInterval(window.timerID);
                                                               window.timerID=0;
                                                             }
                                                            //chat history here
                                                        }
                                                        socket.onmessage = function(e){
                                                            //replace later
                                                            var sender ="Mother Russia";
                                                            console.log('Received: '+e.data);
                                                            //var timeNow = new Date().getTime();
                                                            var msg = JSON.parse(e.data);
                                                            if(msg.SenderID == {{.DOCID}}){
                                                                var senderCheck = true;
                                                            }
                                                            else{
                                                                var senderCheck = false;
                                                            }
                                                            populateMessageModified(urlid, msg.ConversationID, sender,
                                                            msg.Content, '', new Date(msg.TimeStamp).getTime(), senderCheck);
                                                            $(".message-user-message").click(function(){
                                                                 $(this).next().collapse('toggle');
                                                            });
                                                            if (senderCheck==true){
                                                                $('.inbox-group.active .group-message').text("You: "+msg.Content);
                                                            }
                                                            else{
                                                                $('.inbox-group.active .group-message').text(sender+": "+msg.Content); 
                                                            }
                                                            $('.inbox-group.active .group-message-time').text(formatTime(new Date(msg.TimeStamp).getTime()));
                                                             $('#chat'+$.escapeSelector(urlid)).scrollTop( $('.message-box')[0].scrollHeight);
                                                        } 
                                                        socket.onerror= function(err){
                                                            if (err == 1001)socket.close();
                                                        }
                                                        socket.onclose= function(){
                                                          //reconnect now
                                                            if(!window.timerID){
                                                              window.timerID=setInterval(check, Math.floor(Math.random() * 20000) + 5000 );
                                                             }
                                                        };
                                                     }
                                                     catch(exception){
                                                         console.log('Error: '+exception);
                                                    }
                                                }
                                                
                                            }
                                            
                                            
                                            function check(){
                                                if(!socket || socket.readyState == 3) start();
                                            }
                                            
                                            start();
                                            $('.inputMessages').keydown(function (e) {
                                                var temp = window.location.href.indexOf("ch");
                                                var id = window.location.href.substring(temp+3);
                                                if (e.keyCode == 13) {
                                                    $('#chat-submit'+$.escapeSelector(id)).click();
                                                }
                                            });       
                                            $('.chat-submit').click(function(){
                                                var temp = window.location.href.indexOf("ch");
                                                var id = window.location.href.substring(temp+3);
                                                if(socket.readyState === socket.OPEN){
                                                    if ($('#messager'+$.escapeSelector(id))!= '') {
                                                        console.log($('#messager'+$.escapeSelector(id)).val());
                                                        socket.send(JSON.stringify({
                                                            Content:  $('#messager'+$.escapeSelector(id)).val()
                                                        }));
                                                        $('#messager'+$.escapeSelector(id)).val(''); 
                                                    }
                                                }
                                                else {
                                                     if ( $('#messager'+$.escapeSelector(id))!= '') {
                                                       // console.log(socket.readyState+" Message: "+$("#messager"+id).val());
                                                        var timeNow = new Date().getTime();  
                                                        populateOfflineMessage(id,
                                                         $('#messager'+$.escapeSelector(id)).val(), timeNow);
                                                        // $('#chat'+$.escapeSelector(id)).scrollTop($('.message-box')[0].scrollHeight);
                                                       // console.log($('#-1').children(".message-user-message"));
                                                         $('#messager'+$.escapeSelector(id)).val('');
                                                    }
                                                    
                                                }
                                            });
                                            
                                            //switch socket on the fly
                                            $(".inbox-group").on( "click", function(e) {
                                                var chatIden = e.currentTarget.id;
                                                window.history.pushState("", "", "/ch/"+chatIden);
                                                start();
                                                $.ajax({
                                                        type: 'GET',
                                                        url: 'http://ustart.today:'+port+'/AjaxLoadChat/',
                                                        contentType: "application/json; charset=utf-8",
                                                        data: {chatUrl:JSON.stringify(chatIden)},
                                                        success: function(data) {
                                                            console.log(data);
                                                        },error: function(err) {
                                                            console.log('message history failed: ');
                                                            console.log(err);
                                                        }
                                                    });
                                            });
                                        });
                                        
                                    </script>
								</ul>
								<div class="message-foot">
                                    <div class="input-group col-xs-12">
                                        <!-- --------message input ------------------------------------------------------->
                                        <input class="form-control inputMessages" type="text" placeholder="Message here" autocomplete='off' autofocus />
                                        <span class="input-group-addon">
                                            <button class="btn btn-default chat-submit">
                                               <i class="glyphicon glyphicon-chevron-right"></i>
                                            </button>
                                        </span>
                                    </div>
								</div>
							</div>
							<div class="section-right">
								<div class="wrapper">
                                    <nav id="sidebar">
                                            <!-- member list here
                                           <div class="sidebar-header">
                                               <div class="projectMembers">R</div>
                                               <strong>Ryan Rozbiani</strong>
                                            </div>-->
                                    </nav>
                                </div>
							</div>
						</div>
					</div>
					<div class="box-compose">
						<form id="composer-form">
							<div class="input-group col-xs-12">
								<span class="input-group-addon">To</span>
								<input id="composer" class="form-control" type="text" placeholder="Person or Group" autocomplete='off' autofocus />
								<span class="input-group-btn">
									<button class="btn btn-default"><i class="glyphicon glyphicon-chevron-right"></i></button>
								</span>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
    </div>
    <footer id="foot"></footer>
    <script src="/ustart_front/js/fadebody.js"></script>
</body>
</html>