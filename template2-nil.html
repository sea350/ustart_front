<html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="icon" type="image/ico" href="/ustart_front/favicon.ico"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto"/>
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Raleway" />
    <link rel="stylesheet" type="text/css" href="/ustart_front/css/layout.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
       <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="/ustart_front/js/bootstrap-confirmation.min.js"></script>
    <script src="/ustart_front/js/ascii-convert.js"></script>
    <script src="/ustart_front/js/layout.js"></script>
    <script src="/ustart_front/js/chat.js"></script>
    <script src="/ustart_front/js/userEdit.js"></script>
    <script>
        var port = window.location.port;
        var chatNotifCount = 0;
        var chattimerID=0;
        var roomSocket;
        $(document).ready(function () {
            chatNotifCount = $(".chat-label.label-new").length;
            updateChatBadge();
            $('[data-toggle="tooltip"]').tooltip();

            $('.dropdown').on('show.bs.dropdown', function () {
                $(this).find('.dropdown-menu').first().stop(true, true).slideDown();
            });
            $('.dropdown').on('hide.bs.dropdown', function () {
                $(this).find('.dropdown-menu').first().stop(true, true).slideUp();
            });

            $(window).click(function () {
                $('#searchFilters').slideUp('fast');
                $(this).removeClass('search-reveal');
            });
            $('#search-box input[type=search]').focus(function () {
                $('#searchFilters').slideDown('fast');
                $(this).addClass('search-reveal');
            });
            $('#search-box input[type=search], #searchFilters').click(function (event) {
                event.stopPropagation();
            });

            var $window = $(window);
            var $searchForm = $('#form-control');

            function checkWidth(){
                var windowSize = $window.width();
                if (windowSize < 800){
                    $searchForm.hide();
                    $('#searchFilterFormSubmit').addClass('searchResponsive');
                    $('.searchResponsive').css({'background':'none','border':'none'});
                    
                }
                else{
                    $searchForm.show();
                    $('#searchFilterFormSubmit').removeClass('searchResponsive')
                    .css({'background-color':'#fff','border-radius':'4px','border':'1px solid transparent','border-color':'#ccc','border-top-left-radius':'0px','border-bottom-left-radius':'0px'});               
                }
            }
            checkWidth();
            $(window).resize(checkWidth);
            
            $.ajax({
                  type: 'GET',
                    url: 'http://ustart.today:'+port+'/AjaxChatNotifications/',
                    contentType: "application/json; charset=utf-8",
                    data: {},
                    success: function(data) {
                    },complete: function (jqXHR,status) {
                        if(status == 'success' || status=='notmodified')
                        {
                        var temp = $.parseJSON(jqXHR.responseText);
                         if (temp.heads != null){
                             $('#chatDrop').empty();
                             for(i=0; i<temp.heads.length; i++){
                                appendChatItem(temp.heads[i].Username,temp.heads[i].FirstName+' '+temp.heads[i].LastName, readRuneArrayThatWorks(temp.heads[i].Bio), formatTime(temp.heads[i].Time), temp.heads[i].Followed, temp.heads[i].Classification, temp.heads[i].Image, temp.heads[i].DocID);
                             }
                         }
                         else{
                             $('#chatDrop').empty();
                             appendEmptyItem("chatDrop");
                         }
                         chatNotifstart();
                        }
                    }
                    ,error: function(err) {
                        console.log('chat initial chat failed: ');
                        console.log(err);
                    }
            });
            
             function chatNotifstart(){
                //initial set up
                if(!("WebSocket" in window)){
                    console.log("you need a browser that supports web sockets");
                 }else{
                     try{
                     roomSocket= new WebSocket('ws://' + window.location.host + '/cN/');
                     roomSocket.onopen = function(){
                         console.log('Chat Nofitication Socket Status: '+roomSocket.readyState+'(open)');
                         if(window.chattimerID){ /* a setInterval has been fired */
                           window.clearInterval(window.chattimerID);
                           window.chattimerID=0;
                         } 
                     }
                     roomSocket.onmessage = function(e){
                          var chatNotifications = JSON.parse(e.data);
                          if ($('li#chatnotif'+chatNotifications.Username).length > 0){
                              $('li#chatnotif'+chatNotifications.Username).prependTo('#chatDrop');
                              $('li#chatnotif'+chatNotifications.Username+" .notif-message").text(readRuneArrayThatWorks(chatNotifications.Bio));
                              $('li#chatnotif'+chatNotifications.Username+" .notif-timestamp").text(formatTime(new Date(chatNotifications.Time).getTime()));
                              if((readRuneArrayThatWorks(chatNotifications.Bio).substring(0,3)) == "You"){
                                 $('li#chatnotif'+chatNotifications.Username+" .chat-label").css('display', 'none').removeClass('label-new').text('');
                              }
                              else{
                                  $('li#chatnotif'+chatNotifications.Username+" .chat-label").addClass('label-new');
                                  $('li#chatnotif'+chatNotifications.Username+" .chat-label").css('display', 'inline').text("New");
                              }
                              chatNotifCount= $(".chat-label.label-new").length;
                              updateChatBadge();
                          }
                          else{
                             appendChatItem(chatNotifications.Username,chatNotifications.FirstName+' '+chatNotifications.LastName, readRuneArrayThatWorks(chatNotifications.Bio), formatTime(chatNotifications.Time), true, chatNotifications.Classification, chatNotifications.Image, chatNotifications.DocID);
                             $('.emptyState').remove();
                          }
                         if (chatNotifications.Classification == 0){ //REGULAR CHAT  
                            if ($('li#'+$.escapeSelector("@"+chatNotifications.Username)).length != 0){ //chat exists
                               // $('li#'+$.escapeSelector("@"+chatNotifications.Username)).prependTo('#inbox-groups');
                                //check for active here
                                if ($('li#'+$.escapeSelector('@'+chatNotifications.Username)).hasClass('active')){
                                    $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio));
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime()));
                                }
                                else{
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-header').css("font-weight", 700);
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio)).css("font-weight", 700);
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime())).addClass("active").css({'font-weight': "bold"});
                                }
                           }
                           else{    // chat does not exist
                               console.log("creating new chat");
                                populateExistingChatRooms(chatNotifications.Username, chatNotifications.Image, chatNotifications.FirstName+" "+chatNotifications.LastName, chatNotifications.Classification, readRuneArrayThatWorks(chatNotifications.Bio), formatTime(chatNotifications.Time), chatNotifications.DocID);
                                if ($('li#'+$.escapeSelector('@'+chatNotifications.Username)).hasClass('active')){
                                    $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio));
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime()));
                                }
                                else{
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-header').css("font-weight", 700);
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio)).css("font-weight", 700);
                                     $('li#'+$.escapeSelector("@"+chatNotifications.Username)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime())).addClass("active").css({'font-weight': "bold"});
                                }
                           }
                         }
                        else{//PROJECT CHAT
                            if ($('li#'+$.escapeSelector(chatNotifications.DocID)).length != 0){ //chat exists
                                //$('li#'+$.escapeSelector(chatNotifications.Username)).prependTo('#inbox-groups');
                                //check for active here
                                if ($('li#'+$.escapeSelector(chatNotifications.DocID)).hasClass('active')){
                                    $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio));
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime()));
                                }
                                else{
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-header').css("font-weight", 700);
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio)).css("font-weight", 700);
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime())).addClass("active").css({'font-weight': "bold"});
                                }
                           }
                           else{    // chat does not exist
                               populateExistingChatRooms(chatNotifications.Username, chatNotifications.Image, chatNotifications.FirstName+" "+chatNotifications.LastName, chatNotifications.Classification, readRuneArrayThatWorks(chatNotifications.Bio), formatTime(chatNotifications.Time),chatNotifications.DocID );
                               if ($('li#'+$.escapeSelector(chatNotifications.DocID)).hasClass('active')){
                                    $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio));
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime()));
                                }
                                else{
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-header').css("font-weight", 700);
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message').text(readRuneArrayThatWorks(chatNotifications.Bio)).css("font-weight", 700);
                                     $('li#'+$.escapeSelector(chatNotifications.DocID)+' .group-message-time').text(formatTime(new Date(chatNotifications.Time).getTime())).addClass("active").css({'font-weight': "bold"});
                                }
                           }
                        }
                        }// end on message
                     
                        roomSocket.onerror= function(err){
                            if (err == 1001)roomSocket.close();
                        }
                        roomSocket.onclose= function(){
                          //reconnect now
                            if(!window.chattimerID){
                              window.chattimerID=setInterval(checkNotif, Math.floor(Math.random() * 20000) + 5000 );
                             }
                        };

                     }//end try
                      catch(exception){
                         console.log('Error: '+exception);
                    }
                } 
            }
                 
            function checkNotif(){
                if(!roomSocket || roomSocket.readyState == 3){ 
                    chatNotifstart();}
            }
               
        });
    </script>
</head>

<body>
    <nav class="navbar navbar-fixed-top" style="margin-bottom: 0; border-radius: 0;">
        <div class="navbar-header">
            <div class="navbar-filler navbar-left"></div>
            <a id="logo-brand" class="navbar-brand" href="/profile/{{.Username}}">
                <span style="font-size: 27px;">U∙</span><span style="font-size: 27px;">START</span>
            </a>
            <form class="navbar-form nav-item">
                <div class="input-group" id="search-box">
                    <input class="form-control" id='form-control' type="search" name="query" placeholder="Search" form="searchFilterForm" autocomplete="off">
                    <span class="input-group-btn">
                        <button id="searchFilterFormSubmit" class="btn btn-default" type="submit" form="searchFilterForm" style="height: 2.4em">
                            <i class="fa fa-search"></i>
                        </button>
                    </span>
                </div>
            </form>
            <ul class="nav navbar-nav navbar-right">
                <li class="navbar-btn nav-item inbox-list-item" data-toggle="tooltip" data-placement="left" title="Inbox">
                    <a href="/Inbox/">
                        <i class="fa fa-inbox fa-2x" style="color:white;"></i>
                    </a>
                </li>
                <li class="navbar-btn nav-item" data-toggle="tooltip" data-placement="left" title="Messages">
                        <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            <i class="fa fa-comments fa-2x" style="color:white;"></i>
                            <span class="badge chatBadge"></span>
                        </a>
                            <ul class="dropdown-menu">
                            <div id ="chatDrop" class = "padded">
                            </div>
                            <footer class="footer" style ="border-top: 1px solid white;">
                                <a style="margin-left:1em;" href="/ch/">See All Messages</a>
                            </footer>
                            </ul>
                </li>
                <li class="navbar-btn nav-item dropdown" data-toggle="tooltip" data-placement="left" title="Notifications">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell fa-2x" style="color:white;"></i>
                        <span class="badge notifBadge">4</span>
                    </a>
                    <ul id="notifDrop" class="dropdown-menu padded">
                    </ul>
                </li>
                <li class="navbar-btn nav-item dropdown" data-toggle="tooltip" data-placement="left" title="Options">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-chevron-circle-down fa-2x" style="color:white;"></i>
                    </a>
                    <ul id="optionDrop" class="dropdown-menu">
                        <li>
                            <a href="/profile/{{.Username}}">
                                <span id="user-name">Profile</span>
                                <i class="fa fa-user-circle-o" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li>
                            <a href="/MyProjects/">Projects
                                <i class="fa fa-briefcase fa-2x" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="/Settings/">Settings
                                <i class="fa fa-cog" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="/logout/">Logout
                                <i class="fa fa-power-off fa-2x" aria-hidden="true"></i>
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <div id="searchFilters" style="background-color: white; ">
            <div class="navbar-filler navbar-filler-filter navbar-left"></div>
            <form id="searchFilterForm" action="/search" style="margin-bottom: 0">
                <div style="display:inline-block">Filters:</div>
                <div style="display:inline-block">
                    <input type="radio" id="searchFilterGroupUsers" name="searchFilterGroup" value="users" checked />
                    <label for="searchFilterGroupUsers">Users</label>
                    <input type="radio" id="searchFilterGroupProjects" name="searchFilterGroup" value="projects" />
                    <label for="searchFilterGroupProjects">Projects</label>
                    <!-- <input type="radio" id="searchFilterGroupSkills" name="searchFilterGroup" value="skills" checked/>
                    <label for="searchFilterGroupSkills">Skills</label> -->
                </div>
            </form>
        </div>
        <script>
            $('#searchFilters').hide();
        </script>
    </nav>
</body>

</html>